{% extends 'core/base.html' %}
{% block title %}Fraud Analysis | FraudGuard AI{% endblock %}

{% block content %}
<div class="box wide">
    <h2>ğŸ“Š Fraud Detection & Analysis</h2>
    <p class="subtitle">Upload transaction datasets for comprehensive bulk analysis and visualization</p>

    <!-- Upload Section -->
    <div
        style="background: rgba(99, 102, 241, 0.05); border: 2px dashed rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
        <h3 style="margin: 0 0 0.5rem 0;">ğŸ“ Upload Transaction CSV</h3>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">
            Upload a CSV file with columns: amount, transactions, hour
        </p>

        <form method="post" enctype="multipart/form-data"
            style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            {% csrf_token %}
            <input type="file" name="user_csv" required style="max-width: 300px;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <button type="submit" class="button btn-inline">ğŸ” Analyze Dataset</button>
                <a href="{% url 'home' %}" class="button secondary btn-inline">â¬… Back to Dashboard</a>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    {% if analysis_done %}
    <div class="divider"></div>

    <h3>ğŸ“ˆ Analysis Results</h3>

    <!-- Dataset Summary -->
    {% if dataset_summary %}
    <div class="dashboard-grid" style="margin-top: 1.5rem; gap: 1.5rem; grid-template-columns: repeat(3, 1fr);">
        <div class="card"
            style="text-align: center; border-left: 5px solid var(--primary); padding: 1.5rem; justify-content: center;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
            <div
                style="font-weight: 700; color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em;">
                Total Transactions</div>
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary);">{{ dataset_summary.total }}</div>
        </div>

        <div class="card"
            style="text-align: center; border-left: 5px solid var(--danger-text); padding: 1.5rem; justify-content: center; background: rgba(220, 38, 38, 0.03);">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">âš ï¸</div>
            <div
                style="font-weight: 700; color: var(--danger-text); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em;">
                Fraud Detected</div>
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--danger-text);">{{ dataset_summary.fraud }}
            </div>
            <div style="font-weight: 600; color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">
            </div>
        </div>

        <div class="card"
            style="text-align: center; border-left: 5px solid var(--success-text); padding: 1.5rem; justify-content: center; background: rgba(21, 128, 61, 0.03);">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">âœ…</div>
            <div
                style="font-weight: 700; color: var(--success-text); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em;">
                Normal Transactions</div>
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--success-text);">{{ dataset_summary.normal }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts -->
    <div style="margin-top: 2rem;">
        <h4 style="margin-bottom: 1rem;">ğŸ“‰ Fraud Distribution Over Time</h4>
        <div style="background: white; border-radius: 12px; padding: 1rem; border: 1px solid var(--border-light);">
            <img src="/media/{{ fraud_time_chart }}" alt="Fraud Time Chart"
                style="max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <div style="margin-top: 2rem;">
        <h4 style="margin-bottom: 1rem;">ğŸ“Š Fraud vs Normal Probability</h4>
        <div style="background: white; border-radius: 12px; padding: 1rem; border: 1px solid var(--border-light);">
            <img src="/media/{{ prob_chart }}" alt="Fraud Probability Chart"
                style="max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <!-- Fraud List -->
    {% if fraud_records %}
    <div class="divider"></div>

    <div
        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
        <h3 style="margin: 0;">âš ï¸ Detected Fraud Cases</h3>
        <a href="{% url 'export_fraud_csv' %}" class="button btn-inline"
            style="background: linear-gradient(135deg, #10b981, #059669);">
            ğŸ“¥ Download CSV
        </a>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Transactions</th>
                    <th>Hour</th>
                    <th>Fraud Probability</th>
                    <th>Risk Level</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody>
                {% for row in fraud_records %}
                <tr>
                    <td><strong>â‚¹{{ row.amount }}</strong></td>
                    <td>{{ row.transactions }}</td>
                    <td>{{ row.hour }}:00</td>
                    <td>{{ row.fraud_prob }}</td>
                    <td>
                        {% if row.risk_level == 'High' %}
                        <span class="badge fraud">High</span>
                        {% elif row.risk_level == 'Medium' %}
                        <span class="badge warning">Medium</span>
                        {% else %}
                        <span class="badge normal">Low</span>
                        {% endif %}
                    </td>
                    <td><span class="badge reason">{{ row.fraud_reason|default:"N/A" }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="success-message" style="margin-top: 2rem;">
        âœ… Great news! No fraud cases detected in this dataset.
    </div>
    {% endif %}

    {% endif %}

    {% if error %}
    <div class="error-message">
        âŒ {{ error }}
    </div>
    {% endif %}
</div>
{% endblock %}