{% extends 'core/base.html' %}
{% block title %}Fraud Analysis | FraudGuard{% endblock %}

{% block content %}
<div class="box wide">
    <h2>üìä Fraud Detection & Analysis</h2>

    <!-- ===== STEP 1 ===== -->
    <h3>Step 1: Upload Training CSV</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label>Training Dataset (with fraud column)</label>
            <input type="file" name="train_csv" required>
        </div>
        <button type="submit" class="button">Train Model</button>
    </form>

    {% if message %}
    <div class="success-message">{{ message }}</div>
    {% endif %}

    <div class="divider"></div>

    <!-- ===== STEP 2 ===== -->
    <h3>Step 2: Upload User CSV</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label>User Dataset (no fraud column)</label>
            <input type="file" name="user_csv" required>
        </div>
        <button type="submit" class="button">Analyze Fraud</button>
        <a href="{% url 'home' %}" class="button secondary" style="margin-top: 1rem;">‚¨Ö Back to Dashboard</a>
    </form>

    <!-- ===== RESULTS ===== -->
    {% if analysis_done %}
    <div class="divider"></div>
    <h3>üìà Analysis Results</h3>

    <!-- Dataset Summary -->
    {% if dataset_summary %}
    <div class="dashboard-grid">
        <div class="card" style="text-align: center; padding: 1rem;">
            <h4>Total Transactions</h4>
            <p style="font-size: 1.5rem; color: var(--text-main); font-weight: 700;">{{ dataset_summary.total }}</p>
        </div>
        <div class="card" style="text-align: center; padding: 1rem; border-color: var(--danger-bg);">
            <h4 style="color: var(--danger-text);">Fraud Detected</h4>
            <p style="font-size: 1.5rem; color: var(--danger-text); font-weight: 700;">{{ dataset_summary.fraud }}</p>
        </div>
        <div class="card" style="text-align: center; padding: 1rem; border-color: var(--success-bg);">
            <h4 style="color: var(--success-text);">Normal Transactions</h4>
            <p style="font-size: 1.5rem; color: var(--success-text); font-weight: 700;">{{ dataset_summary.normal }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Charts -->
    <h4 style="margin-top: 2rem;">Fraud Count vs Time</h4>
    <img src="/media/{{ fraud_time_chart }}" alt="Fraud Time Chart"
        style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border-light); margin-bottom: 2rem;">

    <h4>Fraud vs Normal Probability</h4>
    <img src="/media/{{ prob_chart }}" alt="Fraud Probability Chart"
        style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border-light);">

    <!-- ===== STEP 3: FRAUD LIST ===== -->
    {% if fraud_records %}
    <div class="divider"></div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>‚ö†Ô∏è Detected Fraud Cases</h3>
        <a href="{% url 'export_fraud_csv' %}" class="button btn-inline" style="background: var(--success-text);">
            üì• Download CSV
        </a>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Transactions</th>
                    <th>Hour</th>
                    <th>Fraud Prob</th>
                    <th>Risk Level</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in fraud_records %}
                <tr>
                    <td>‚Çπ{{ row.amount }}</td>
                    <td>{{ row.transactions }}</td>
                    <td>{{ row.hour }}</td>
                    <td>{{ row.fraud_prob }}</td>
                    <td>
                        {% if row.risk_level == 'High' %}
                        <span class="badge fraud">High</span>
                        {% elif row.risk_level == 'Medium' %}
                        <span class="badge warning">Medium</span>
                        {% else %}
                        <span class="badge normal">Low</span>
                        {% endif %}
                    </td>
                    <td><span class="badge fraud" style="background:#000; color:#fff;">Detected</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="success-message" style="margin-top: 2rem;">
        ‚úÖ No fraud cases detected in this dataset.
    </div>
    {% endif %}

    {% endif %}
</div>
{% endblock %}